#MakeSpecialDBsc.tmp - SpecialDBsc make template.
# 9/22/22.    wmk.   (automated) *codebase env var support.
# 9/22/22.    wmk.   (automated) CB *codebase env var support.
#	7/2/21.	wmk.
#
#
# Entry. pathSCdefs.inc - include file SC path definitions
#		pathSCdefs.inc derived from generic ~/include/pathSCdefs.i
#			via Build dependency
#		(vpath .db)TerrWatersideDr_SC.db - territory SC current download
#		(vpath .csv) MapWatersideDr_SC.csv - territory SC .csv download raw data
#		var postpath = postprocessing path to TerrWatersideDr/FixWatersideDrSC.sh
 # var bashpath(codebase)
#
# Modification History.
# ---------------------
# 6/7/21.	wmk.	original makefile; adapted from MakeUpdateSCDwnld.tmp
# 7/2/21.	wmk.	multihost code improvments.
# 9/3/21.	wmk.	pathSCdefs.inc, FixSCMenu.inc qualified to support this
#					as nested make.	

#
# Notes. This makefile mimics UpdateSCBridge in cases where most, or all,
# of the download data is in a Special/<area-name>.csv file. It uses the
# shell SCSpecTerr_db.sh to create a new Terrxxx_SC.db database that looks
# exactly like that created by SCNewTerr_db.sh.

# Note. Will not work if there is not SCBridge data.
# update happens if SCPA-Downloads/TerrWatersideDr/MapWatersideDr_SC.csv newer than TerrWatersideDr_SC.db
# also will happen if either FixWatersideDrSC.sql or FixWatersideDrSC.sh newer than TerrWatersideDr_SC.db
# fatal errors detected: no MapWatersideDr_SC.csv file, FixWatersideDrSC.sh missing or out-of-date
#  and no FixWatersideDrSC.sql file.
#
#vpath %.db /media/ubuntu/Windows/Users/Bill/Territories/RawData/SCPA/SCPA-Downloads/TerrWatersideDr
#vpath %.csv /media/ubuntu/Windows/Users/Bill/Territories/RawData/SCPA/SCPA-Downloads/TerrWatersideDr
 #bashpath = "/media/ubuntu/Windows/Users/Bill/Territories/Procs-Dev/"(codebase)
#postpath = "/media/ubuntu/Windows/Users/Bill/Territories/RawData/SCPA/SCPA-Downloads/TerrWatersideDr/"

#<dbname>.db		: <dbname>.csv
	#sql to take <dbname>.csv and create a Mapxxx_SC.db type database
	# with SCRaw and SCPoly tables from which to extract records into
	# Terrxxx_SC.db SCRaw and SCPoly tables. This will be useful
	# for convoluted territories like 289 in Gondola Park where it is
	# nearly impossible to get SCPA to extract the proper records
	# for the UnitAddress set in the territory.


.ONESHELL : ;
.NOTPARALLEL : ;
.PHONY : WarnUser NeverMake ;


# use ($)USER to determine host system.
ifeq ($(USER),ubuntu)
 folderbase = "/media/ubuntu/Windows/Users/Bill"
else
 folderbase = $(HOME)
endif

incroot = $(folderbase)/Territories/include/
specpath = $(folderbase)/Territories/RawData/SCPA/SCPA-Downloads/Special/
vpath %.i $(folderbase)/Territories/include
 projpath = $(codebase)/Territories/Projects-Geany/SpecialSCdb

include $(projpath)/pathSCdefs.inc

# new definition - supports FixWatersideDrSC.sh if provided.
#TerrWatersideDr_SC.db  : MapWatersideDr_SC.csv $(postpath)FixWatersideDrSC.sql $(postpath)FixWatersideDrSC.sh
#pathSCdefs.inc appended to previous line..

# same as UpdateSCDwnld except first step - SCSpecTerr_db.sh.
# WatersideDr is territory id;  is special .csv/database name.
TerrWatersideDr_SC.db  : $(specpath).csv $(postpath)FixWatersideDrSC.sh
 # echo "bashpath(codebase)
	bash $(bashpath)SCSpecTerr_db.sh WatersideDr 
	bash $(bashpath)SCTidyTerr_db.sh WatersideDr
	bash $(bashpath)FixXXXsc.sh WatersideDr
	touch $(postpath)FixWatersideDrSC.sh
	sleep 3
	bash $(postpath)FixWatersideDrSC.sh
	bash $(bashpath)SetSCDNCs.sh WatersideDr
	bash $(bashpath)MissingIDs.sh WatersideDr
#	bash $(bashpath)SCTidyTerr_db.sh WatersideDr

# 6/6/21. note, second recipe winds up in infinite loop...
pathSCdefs.inc : NeverMake ;
#pathSCdefs.inc : pathSCdefs.i
#	echo "incroot = '$(incroot)'"
#	sed 's/xxx/WatersideDr/g' $(incroot)pathSCdefs.i > pathSCdefs.inc

pathSCdefs.i : ;

$(specpath).csv : ;

NeverMake : ;

# this target can only be generated by download.
# if it doesn't exist, message user to perform new download.
$(postpath)MapWatersideDr_SC.csv : ; 

WarnUser : ;$(error "** MapWatersideDr_SC.csv missing - find or perform new download **")

#FixWatersideDrSC.sql, FixWatersideDrSC.sh recipe.
include $(projpath)/FixSCMenu.inc

$(bashpath)SCTidyTerr_db.sh : $(SCQpath)SCTidyTerr_db.sql
#	echo "You need to rebuild SCTidyTerr_db.sh..."
#	the following make will build SCTidyTerr_db.sh
	cd ../SCTidyTerr && $(MAKE) -f MakeSCTidyTerr
	cp $(SCQBpath)SCTidyTerr_db.sh $(bashpath)SCTidyTerr_db.sh
	
$(SCQpath)SCTidyTerr_db.sql : ;
