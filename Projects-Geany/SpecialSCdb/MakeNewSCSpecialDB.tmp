#MakeNewSCSpecialDB.tmp - NewSCSpecialDB make template.
#	12/24/22.	wmk.
#
#
# Entry. pathSCdefs.inc - include file SC path definitions
#		pathSCdefs.inc derived from generic ~/include/pathSCdefs.i
#			via Build dependency
#		(vpath .db)Terryyy_SC.db - territory SC current download
#		(vpath .csv) Mapyyy_SC.csv - territory SC .csv download raw data
#		var postpath = postprocessing path to Terryyy/FixyyySC.sh
 # var bashpath(codebase)
#
# Modification History.
# ---------------------
# 12/24/22.	wmk.	original code; adapted from MakeSpecialSCdb.tmp
# Legacy mods.
# 9/22/22.    wmk.   (automated) *codebase env var support.
# 9/22/22.    wmk.   (automated) CB *codebase env var support.
# Legacy mods.
# 6/7/21.	wmk.	original makefile; adapted from MakeUpdateSCDwnld.tmp
# 7/2/21.	wmk.	multihost code improvments.
# 9/3/21.	wmk.	USR corrected to USER.
#
# Notes. This makefile mimics UpdateSCBridge in cases where most, or all,
# of the download data is in a Special/<area-name>.csv file. It uses the
# shell SCSpecTerr_db.sh to create a new Terrxxx_SC.db database that looks
# exactly like that created by SCNewTerr_db.sh.

# Note. Will not work if there is not SCBridge data.
# update happens if SCPA-Downloads/Terryyy/Mapyyy_SC.csv newer than Terryyy_SC.db
# also will happen if either FixyyySC.sql or FixyyySC.sh newer than Terryyy_SC.db
# fatal errors detected: no Mapyyy_SC.csv file, FixyyySC.sh missing or out-of-date
#  and no FixyyySC.sql file.
#
#vpath %.db /media/ubuntu/Windows/Users/Bill/Territories/RawData/SCPA/SCPA-Downloads/Terryyy
#vpath %.csv /media/ubuntu/Windows/Users/Bill/Territories/RawData/SCPA/SCPA-Downloads/Terryyy
 #bashpath = "/media/ubuntu/Windows/Users/Bill/Territories/Procs-Dev/"(codebase)
#postpath = "/media/ubuntu/Windows/Users/Bill/Territories/RawData/SCPA/SCPA-Downloads/Terryyy/"

#<dbname>.db		: <dbname>.csv
	#sql to take <dbname>.csv and create a Mapxxx_SC.db type database
	# with SCRaw and SCPoly tables from which to extract records into
	# Terrxxx_SC.db SCRaw and SCPoly tables. This will be useful
	# for convoluted territories like 289 in Gondola Park where it is
	# nearly impossible to get SCPA to extract the proper records
	# for the UnitAddress set in the territory.


.ONESHELL : ;
.NOTPARALLEL : ;
.PHONY : WarnUser NeverMake ;


# use ($)USR to determine host system.
ifndef folderbase
 ifeq ($(USER),ubuntu)
  folderbase = "/media/ubuntu/Windows/Users/Bill"
 else
  folderbase = $(HOME)
 endif
endif

ifndef codebase
 codebase = $(folderbase)/GitHub/TerritoriesCB
endif

ifndef pathbase
 pathbase = $(folderbase)/Territories/FL/SARA/86777
endif

incroot = $(codebase)/include/
specpath = $(folderbase)/Territories/RawData/SCPA/SCPA-Downloads/Special/
vpath %.i $(codebase)/include
thisproj = $(codebase)/Projects-Geany/SpecialSCdb
altproj = $(codebase)/Projects-Geany/AnySQLtoSH

#include pathSCdefs.inc
bashpath = $(codebase)/Procs-Dev


# same as UpdateSCDwnld except first step - SCSpecTerr_db.sh.
# yyy is territory id; vvvvv is special .csv/database name.
#============================================================
$(specpath)/<spec-db>.db  : $(thisproj)/NewSCSpecialDB.sh
	$(specpath)/NewSCSpecialDB.sh

$(specpath)/NewSCSpecialDB.sh : $(specpath)/NewSCSpecialDB.sql
	cd $(altproj);./DoSed.sh $(specpath) NewSCSpecialDB
	$(MAKE) -f $(altproj)/MakeAnySQLtoSH
	
$(specpath)/NewSpecialDB.sql : ;
	if ! test -f $@;then
	 echo "  ** missing NewSpecialDB.sql for NewSpecialDB.sh build **";exit 1;fi
	 
################################# old makefile ###################
 # echo "bashpath(codebase)
	bash $(bashpath)SCSpecTerr_db.sh yyy vvvvv
	bash $(bashpath)SCTidyTerr_db.sh yyy
	bash $(bashpath)FixXXXsc.sh yyy
	touch $(postpath)FixyyySC.sh
	sleep 3
	bash $(postpath)FixyyySC.sh
	bash $(bashpath)SetSCDNCs.sh yyy
	bash $(bashpath)MissingIDs.sh yyy
#	bash $(bashpath)SCTidyTerr_db.sh yyy

# 6/6/21. note, second recipe winds up in infinite loop...
pathSCdefs.inc : NeverMake ;
#pathSCdefs.inc : pathSCdefs.i
#	echo "incroot = '$(incroot)'"
#	sed 's/xxx/yyy/g' $(incroot)pathSCdefs.i > pathSCdefs.inc

pathSCdefs.i : ;

$(specpath)vvvvv.csv : ;

NeverMake : ;

# this target can only be generated by download.
# if it doesn't exist, message user to perform new download.
$(postpath)Mapyyy_SC.csv : ; 

WarnUser : ;$(error "** Mapyyy_SC.csv missing - find or perform new download **")

#FixyyySC.sql, FixyyySC.sh recipe.
include FixSCMenu.inc

$(bashpath)SCTidyTerr_db.sh : $(SCQpath)SCTidyTerr_db.sql
#	echo "You need to rebuild SCTidyTerr_db.sh..."
#	the following make will build SCTidyTerr_db.sh
	cd ../SCTidyTerr && $(MAKE) -f MakeSCTidyTerr
	cp $(SCQBpath)SCTidyTerr_db.sh $(bashpath)SCTidyTerr_db.sh
	
$(SCQpath)SCTidyTerr_db.sql : ;
